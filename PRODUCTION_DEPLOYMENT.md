# Production Deployment Guide - Contractorv3

## Overview
Contractorv3 is a Google Cloud Platform (GCP) native application with zero AWS dependencies. This guide covers production deployment, monitoring, and operations.

## Architecture

### Components
- **Backend**: Node.js/Express API on Cloud Run
- **Frontend**: React SPA on Cloud Storage + Cloud CDN
- **Database**: Cloud SQL PostgreSQL
- **Secrets**: Secret Manager
- **Build**: Cloud Build
- **Monitoring**: Cloud Logging + Cloud Monitoring

### Key Features
- ✅ **Zero AWS Dependencies**: Pure GCP stack
- ✅ **Structured Logging**: JSON logs compatible with Cloud Logging
- ✅ **Distributed Tracing**: Correlation IDs across all requests
- ✅ **Auto-scaling**: Cloud Run scales from 0 to 10 instances
- ✅ **Security**: Non-root containers, secret management, vulnerability scanning
- ✅ **Performance**: Database query monitoring, automatic retries, exponential backoff

## Prerequisites

1. **GCP Project Setup**
   ```bash
   gcloud config set project YOUR_PROJECT_ID
   ```

2. **Enable Required APIs**
   ```bash
   gcloud services enable \
     cloudbuild.googleapis.com \
     run.googleapis.com \
     sqladmin.googleapis.com \
     storage.googleapis.com \
     secretmanager.googleapis.com
   ```

3. **Install gcloud SDK**
   - Download from https://cloud.google.com/sdk/docs/install

## Deployment Steps

### Option 1: Automated Full Deployment

Use the provided script for a complete setup from scratch:

```bash
./full-deploy.sh
```

This script will:
- Authenticate with GCP
- Create Cloud SQL instance
- Set up Secret Manager
- Create Cloud Storage bucket
- Deploy backend to Cloud Run
- Deploy frontend to Cloud Storage
- Configure all necessary resources

### Option 2: Manual Deployment

#### Step 1: Set Up Secrets

```bash
# Database URL
echo -n "postgresql://USER:PASSWORD@/DB?host=/cloudsql/PROJECT:REGION:INSTANCE" | \
  gcloud secrets create DATABASE_URL --data-file=-

# JWT Secret
echo -n "$(openssl rand -base64 32)" | \
  gcloud secrets create JWT_SECRET --data-file=-

# API Keys
echo -n "YOUR_GEMINI_API_KEY" | \
  gcloud secrets create GEMINI_API_KEY --data-file=-

echo -n "YOUR_TAVILY_API_KEY" | \
  gcloud secrets create TAVILY_API_KEY --data-file=-

echo -n "YOUR_MAPS_API_KEY" | \
  gcloud secrets create MAPS_API_KEY --data-file=-
```

#### Step 2: Deploy Backend

```bash
cd server
gcloud builds submit --config cloudbuild.backend.yaml
```

#### Step 3: Get Backend URL

```bash
BACKEND_URL=$(gcloud run services describe contractorv3-backend \
  --region=us-central1 \
  --format='value(status.url)')
echo $BACKEND_URL
```

#### Step 4: Deploy Frontend

```bash
cd client
gcloud builds submit --config cloudbuild.frontend.yaml \
  --substitutions=_BACKEND_URL=$BACKEND_URL
```

## Environment Variables

### Backend Environment Variables

Set in Cloud Run service:

| Variable | Description | Required | Default |
|----------|-------------|----------|---------|
| `NODE_ENV` | Environment mode | Yes | `production` |
| `PORT` | Server port | Yes | `8080` |
| `DATABASE_URL` | PostgreSQL connection string | Yes | From Secret Manager |
| `JWT_SECRET` | JWT signing secret | Yes | From Secret Manager |
| `GEMINI_API_KEY` | Google Gemini API key | No | From Secret Manager |
| `TAVILY_API_KEY` | Tavily Search API key | No | From Secret Manager |
| `CORS_ORIGIN` | Allowed CORS origins | No | `*` |
| `AUTH_DISABLED` | Disable auth for demo | No | `false` |

### Frontend Environment Variables

Set during build:

| Variable | Description | Required |
|----------|-------------|----------|
| `VITE_API_URL` | Backend API URL | Yes |
| `VITE_MAPS_API_KEY` | Google Maps API key | No |

## Monitoring & Logging

### Structured Logging

All logs follow this format for Cloud Logging compatibility:

```json
{
  "timestamp": "2024-01-01T00:00:00.000Z",
  "severity": "INFO",
  "correlationId": "client-1234567890-abc123",
  "httpRequest": {
    "requestMethod": "POST",
    "requestUrl": "/api/leads",
    "status": 201,
    "latency": "1245ms"
  }
}
```

### Correlation IDs

Every request has a unique correlation ID for distributed tracing:
- Generated by client: `client-{timestamp}-{random}`
- Propagated via `X-Correlation-ID` header
- Included in all logs and error responses

### Query Performance Monitoring

Slow database queries (>1s) are automatically logged:

```json
{
  "severity": "WARNING",
  "message": "Slow database query detected",
  "duration": "1245ms",
  "query": "SELECT * FROM leads WHERE..."
}
```

### Viewing Logs

```bash
# View backend logs
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=contractorv3-backend" \
  --limit 50 \
  --format json

# Filter by correlation ID
gcloud logging read "jsonPayload.correlationId='client-1234567890-abc123'" \
  --format json

# View slow queries
gcloud logging read "jsonPayload.message='Slow database query detected'" \
  --format json
```

## Security

### Implemented Security Measures

1. **Vulnerability Scanning**
   - All dependencies scanned for known CVEs
   - Automated security updates via npm audit

2. **Input Sanitization**
   - Address parsing removes dangerous characters
   - Length limits on all user inputs
   - Prisma protects against SQL injection

3. **Authentication**
   - JWT-based authentication
   - Token refresh mechanism
   - Automatic retry with exponential backoff

4. **Container Security**
   - Non-root user in containers
   - Minimal Alpine Linux base image
   - Read-only file systems where possible

5. **Network Security**
   - CORS configuration
   - HTTPS only in production
   - Cloud Armor (optional)

### Security Updates

```bash
# Check for vulnerabilities
cd server && npm audit
cd client && npm audit

# Fix automatically fixable vulnerabilities
cd server && npm audit fix
cd client && npm audit fix
```

## Performance Optimization

### Database Connection Pooling

Prisma automatically manages connection pooling. Configure via `DATABASE_URL`:

```
postgresql://user:pass@host/db?connection_limit=10&pool_timeout=20
```

### Cloud Run Configuration

Current settings:
- **Memory**: 512Mi (can increase to 2Gi)
- **CPU**: 1 vCPU (can increase to 4)
- **Min instances**: 0 (cold starts enabled)
- **Max instances**: 10 (auto-scales based on load)
- **Timeout**: 300s
- **Concurrency**: 80 requests per instance

### CDN & Caching

Enable Cloud CDN for frontend:

```bash
gcloud compute backend-buckets create contractorv3-frontend-backend \
  --gcs-bucket-name=contractorv3-frontend \
  --enable-cdn
```

## Troubleshooting

### Common Issues

#### 1. Database Connection Failures

```bash
# Check Cloud SQL instance status
gcloud sql instances describe contractorv3-db

# Test connection
gcloud sql connect contractorv3-db --user=postgres
```

#### 2. Build Failures

```bash
# Check Cloud Build logs
gcloud builds list --limit=5

# View specific build
gcloud builds log BUILD_ID
```

#### 3. Backend Not Responding

```bash
# Check service status
gcloud run services describe contractorv3-backend --region=us-central1

# View recent logs
gcloud logging read "resource.type=cloud_run_revision" --limit=50
```

#### 4. CORS Errors

Update CORS_ORIGIN environment variable:

```bash
gcloud run services update contractorv3-backend \
  --region=us-central1 \
  --set-env-vars CORS_ORIGIN=https://yourdomain.com
```

## Cost Optimization

### Estimated Monthly Costs

| Component | Configuration | Estimated Cost |
|-----------|--------------|----------------|
| Cloud Run | 512Mi, 0-10 instances | $5-15 |
| Cloud SQL | db-f1-micro | $8-10 |
| Cloud Storage | Frontend hosting | $1-2 |
| Secret Manager | 5 secrets | $0.30 |
| Cloud Build | ~50 builds/month | $0-5 |
| **Total** | | **$14-32/month** |

### Cost-Saving Tips

1. **Use Cloud Run min-instances=0** for development
2. **Enable Cloud SQL automatic backups** only if needed
3. **Set up budget alerts** at $20, $40, $60
4. **Use Cloud CDN** to reduce Cloud Run traffic

## Maintenance

### Regular Tasks

#### Weekly
- Review Cloud Logging for errors
- Check slow query logs
- Monitor response times

#### Monthly
- Run security audits (`npm audit`)
- Update dependencies
- Review costs and optimize
- Test backup restoration

#### Quarterly
- Update API keys
- Review access controls
- Performance testing
- Security review

## Support & Resources

- **GCP Console**: https://console.cloud.google.com
- **Cloud Logging**: https://console.cloud.google.com/logs
- **Cloud Monitoring**: https://console.cloud.google.com/monitoring
- **Documentation**: See README.md, GCP_DEPLOYMENT.md

## Summary of Changes (v3.0)

### Improvements Made
✅ Removed all AWS dependencies
✅ Added structured logging with correlation IDs
✅ Implemented automatic retry logic with exponential backoff
✅ Enhanced error handling across all layers
✅ Added input sanitization and security improvements
✅ Fixed security vulnerabilities (axios, jws)
✅ Implemented slow query monitoring
✅ Added distributed tracing with correlation IDs
✅ Improved Dockerfile security and permissions
✅ Enhanced API client with retry logic

### Zero AWS Artifacts
- ❌ No Elastic Beanstalk configurations
- ❌ No AWS SDK dependencies
- ❌ No S3 references
- ❌ No Lambda handlers
- ❌ No Amplify configs
- ✅ Pure GCP deployment pipeline
