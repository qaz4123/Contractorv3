steps:
  # Install dependencies
  - name: 'node:20'
    entrypoint: 'npm'
    args: ['ci']

  # Build frontend with backend URL and Maps key
  - name: 'node:20'
    entrypoint: 'npm'
    args: ['run', 'build']
    env:
      - 'VITE_API_URL=${_BACKEND_URL}'
      - 'VITE_GOOGLE_MAPS_API_KEY=$$MAPS_API_KEY'
    secretEnv: ['MAPS_API_KEY']

  # Deploy to Cloud Storage
  - name: 'gcr.io/cloud-builders/gsutil'
    args:
      - '-m'
      - 'rsync'
      - '-r'
      - '-d'
      - 'dist/'
      - 'gs://${_BUCKET_NAME}/'



availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/MAPS_API_KEY/versions/latest
      env: 'MAPS_API_KEY'

options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _BUCKET_NAME: 'contractorv3-frontend'
  _BACKEND_URL: 'https://contractorv3-backend-l5y4e3htka-uc.a.run.app/api'

timeout: '600s'
